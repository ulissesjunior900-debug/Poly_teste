{% set usar_tailwind = true %}
{% extends 'base.html' %}


{% block title %}Dashboard - PolyMusic{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .status-badge {
        padding: 0.35rem 0.65rem;
        font-size: 0.75rem;
        border-radius: 50rem;
    }
    
    .table-row-hover:hover {
        background-color: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Bem-vindo ao Sistema de Gerenciamento de Royalties da PolyMusic.</h1>
            <p class="text-gray-600">Resumo Financeiro</p>
        </div>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 mt-2 md:mt-0">
            <i class="fas fa-clock mr-1 text-gray-500"></i>
            Ultima atualização: {{ data_ultima_atualizacao }}
        </span>
    </div>
    
    <hr class="my-4 border-gray-200">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="dashboard-card bg-white rounded-xl shadow-sm border-l-4 border-indigo-500 p-5 transition-all duration-300">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total de Artistas</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ total_artistas.normais + total_artistas.especiais + total_artistas.assisao }}</h3>
                </div>
                <div class="p-3 rounded-full bg-indigo-50 text-indigo-700">
                    <i class="fas fa-users text-2xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>Normais: {{ total_artistas.normais }}</span>
                    <span>Especiais: {{ total_artistas.especiais }}</span>
                    <span>Assisão: {{ total_artistas.assisao }}</span>
                </div>
            </div>
        </div>
        
        <div class="dashboard-card bg-white rounded-xl shadow-sm border-l-4 border-green-500 p-5 transition-all duration-300">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total de Usuários</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ total_usuarios }}</h3>
                </div>
                <div class="p-3 rounded-full bg-green-50 text-green-700">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <span class="text-sm text-green-600 font-medium">
                    <i class="fas fa-arrow-up mr-1"></i> 8% desde o último mês
                </span>
            </div>
        </div>
        
        <div class="dashboard-card bg-white rounded-xl shadow-sm border-l-4 border-blue-500 p-5 transition-all duration-300">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Cálculos Recentes</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ total_calculos }}</h3>
                </div>
                <div class="p-3 rounded-full bg-blue-50 text-blue-700">
                    <i class="fas fa-calculator text-2xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <span class="text-sm text-red-600 font-medium">
                    <i class="fas fa-arrow-down mr-1"></i> 5% desde o último mês
                </span>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-5">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Top 5 Artistas Mais Rentáveis (Valores em R$)</h3>
                <button class="flex items-center px-3 py-1 bg-gray-50 hover:bg-gray-100 rounded-lg text-sm font-medium text-gray-600" id="btnExportChart">
                    <i class="fas fa-download mr-2"></i>
                    Exportar
                </button>
            </div>
            <div class="chart-container">
                {% if top_artistas_royalties %}
                <canvas id="graficoTopArtistas"></canvas>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-pie text-4xl text-gray-300 mb-3"></i>
                    <p class="mt-2 text-gray-500">Nenhum dado disponível para exibir</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-6">Resumo Financeiro</h3>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-700">Total em Euros:</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                            € {{ "{:,.2f}".format(valor_total_eur|float).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        </span>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-700">Total em Reais:</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                            R$ {{ "{:,.2f}".format(valor_total_brl|float).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        </span>
                    </div>
                </div>
            </div>
            
            <hr class="my-4 border-gray-200">
            
            <h4 class="font-medium text-gray-500 mb-3">Distribuição por Tipo</h4>
            <div style="height: 150px;">
                <canvas id="graficoDistribuicao"></canvas>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="flex justify-between items-center p-5 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Últimos Cálculos Processados</h3>
            <a href="{{ url_for('calcular') }}" class="flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm font-medium text-white">
                <i class="fas fa-plus-circle mr-2"></i>
                Novo Cálculo
            </a>
        </div>
        
        <div class="overflow-x-auto">
            {% if calculos_recentes %}
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Artista</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (€)</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Período</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for calculo in calculos_recentes %}
                    <tr class="table-row-hover">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ calculo.artista }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">€ {{ "%0.2f"|format(calculo.valor_eur|float) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">R$ {{ "%0.2f"|format(calculo.valor_brl|float) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ calculo.mes }} {{ calculo.ano }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="status-badge bg-{{ 'blue-100 text-blue-800' if calculo.tipo == 'Normal' else 'yellow-100 text-yellow-800' if calculo.tipo == 'Especial' else 'purple-100 text-purple-800' }}">
                                {{ calculo.tipo }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="status-badge bg-{{ 'green-100 text-green-800' if calculo.status == 'Pago' else 'gray-100 text-gray-800' }}">
                                {{ calculo.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="text-gray-400 hover:text-indigo-600 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="fas fa-exclamation-circle text-4xl text-gray-300 mb-3"></i>
                <p class="mt-2 text-gray-500">Nenhum cálculo recente encontrado</p>
            </div>
            {% endif %}
        </div>
        
        {% if calculos_recentes %}
        <div class="flex items-center justify-between px-5 py-3 border-t bg-gray-50">
            <div class="text-sm text-gray-500">
                Mostrando <span class="font-medium">1</span> a <span class="font-medium">{{ calculos_recentes|length }}</span> de <span class="font-medium">{{ total_calculos }}</span> resultados
            </div>
            <div class="flex space-x-2">
                <button class="px-3 py-1 border rounded-md text-sm font-medium text-gray-500 bg-white">Anterior</button>
                <button class="px-3 py-1 border rounded-md text-sm font-medium text-white bg-indigo-600">1</button>
                <button class="px-3 py-1 border rounded-md text-sm font-medium text-gray-500 bg-white hover:bg-gray-50">2</button>
                <button class="px-3 py-1 border rounded-md text-sm font-medium text-gray-500 bg-white hover:bg-gray-50">3</button>
                <button class="px-3 py-1 border rounded-md text-sm font-medium text-gray-500 bg-white">Próximo</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-image"></script> 

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Gráfico Top Artistas por Royalties
        try {
            const artistas = {{ top_artistas_royalties|map(attribute='artista')|list|tojson }};
            const valores = {{ top_artistas_royalties|map(attribute='total_brl')|list|tojson }};
            
            if (artistas.length === 0 || valores.length === 0) {
                throw new Error('Dados vazios');
            }

            const ctxArtistas = document.getElementById('graficoTopArtistas').getContext('2d');

            new Chart(ctxArtistas, {
                type: 'bar',
                data: {
                    labels: artistas,
                    datasets: [{
                        label: 'Royalties em R$',
                        data: valores,
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)',
                            'rgba(99, 102, 241, 0.7)',
                            'rgba(129, 140, 248, 0.7)',
                            'rgba(165, 180, 252, 0.7)',
                            'rgba(199, 210, 254, 0.7)'
                        ],
                        borderColor: [
                            'rgba(79, 70, 229, 1)',
                            'rgba(99, 102, 241, 1)',
                            'rgba(129, 140, 248, 1)',
                            'rgba(165, 180, 252, 1)',
                            'rgba(199, 210, 254, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'R$ ' + context.raw.toLocaleString('pt-BR', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            },
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return 'R$ ' + (value / 1000).toFixed(1) + 'k';
                                    }
                                    return 'R$ ' + value;
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Botão Exportar Gráfico
            document.getElementById('btnExportChart').addEventListener('click', function() {
                const canvas = document.getElementById('graficoTopArtistas');
                const link = document.createElement('a');
                link.download = 'top-artistas-royalties-' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        } catch (error) {
            console.error('Erro ao carregar gráfico:', error);
            document.getElementById('graficoTopArtistas').closest('.chart-container').innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-300 mb-3"></i>
                    <p class="mt-2 text-gray-500">Erro ao carregar dados do gráfico</p>
                </div>
            `;
        }

        // 2. Gráfico de Distribuição com dados reais
        const ctxDist = document.getElementById('graficoDistribuicao').getContext('2d');
        new Chart(ctxDist, {
            type: 'doughnut',
            data: {
                labels: ['Normais', 'Especiais', 'Assisão'],
                datasets: [{
                    data: [
                        {{ distribuicao_calculos.normais }},
                        {{ distribuicao_calculos.especiais }},
                        {{ distribuicao_calculos.assisao }}
                    ],
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(139, 92, 246, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // 3. Atualização automática a cada 1 minuto
        setTimeout(function() {
            window.location.reload();
        }, 60000);
    });
</script>
{% endblock %}